pipeline {
    agent any
    environment {
        APIKEY = credentials('IBM_CLOUD_API_KEY') // Define la credencial en Jenkins previamente
    }
    parameters {
        string(name: 'MICROSERVICE', defaultValue: 'frontend', description: 'Nombre del microservicio (frontend/backend)')
    }
    stages {
        stage('Determinar Ambiente') {
            steps {
                script {
                    if (env.BRANCH_NAME == 'main') {
                        env.ENVIRONMENT = 'production'
                    } else {
                        env.ENVIRONMENT = 'develop'
                    }
                    echo "Ambiente configurado: ${env.ENVIRONMENT}"
                }
            }
        }
        stage('Test Frontend') {
            when {
                allOf {
                    expression { params.MICROSERVICE == 'frontend' }
                    branch 'main'
                }
            }
            steps {
                echo "Configurando y ejecutando linter"
                sh """
                npm install eslint --save-dev
                npx eslint --init
                npx eslint . --ext .js,.jsx,.ts,.tsx
                """
            }
        }
        stage('Configurar default.conf') {
            when {
                expression { params.MICROSERVICE == 'frontend' }
            }
            steps {
                script {
                    def confPath = "default.conf"
                    def backendUrl = params.ENVIRONMENT == 'develop' 
                        ? "http://backend-develop-svc:8080" 
                        : "http://backend-production-svc:8080"
                    def location = params.ENVIRONMENT == 'develop' 
                        ? "/dev-vsanchez" 
                        : "/prod-vsanchez"
                    sh """
                    sed -i "s|proxy_pass http://svc-backend:8080;|proxy_pass ${backendUrl};|g" ${confPath}
                    sed -i "s|location /pepe-vsanchez |location ${location} |g" ${confPath}
                    """
                    sh "cat ${confPath}"
                }
            }
        }
        stage('Instalar Herramientas') {
            steps {
                sh """
                curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
                curl -fsSL https://clis.cloud.ibm.com/install/linux | sh
                ibmcloud plugin install container-registry -r 'IBM Cloud'
                ibmcloud plugin install container-service -r 'IBM Cloud'
                """
            }
        }
        stage('Login IBM Cloud') {
            steps {
                sh """
                ibmcloud login --apikey ${APIKEY} -r eu-gb
                ibmcloud target -g Stemdo_Sandbox
                ibmcloud cr login
                """
            }
        }
        stage('Extraer Versión') {
            steps {
                script {
                    if (params.MICROSERVICE == 'frontend') {
                        env.VERSION = sh(
                            script: "node -pe 'require(\"./package.json\").version'",
                            returnStdout: true
                        ).trim()
                    } else if (params.MICROSERVICE == 'backend') {
                        env.VERSION = sh(
                            script: "xmllint --xpath \"string(//version)\" pom.xml",
                            returnStdout: true
                        ).trim()
                    }
                    echo "Versión detectada: ${env.VERSION}"
                }
            }
        }
        stage('Construir Imagen') {
            steps {
                sh "docker build -t imagen-proyecto-${params.MICROSERVICE}-${env.ENVIRONMENT} ."
            }
        }
        stage('Taggear Imagen') {
            steps {
                sh """
                docker tag imagen-proyecto-${params.MICROSERVICE}-${env.ENVIRONMENT} uk.icr.io/cr-vsanchez/imagen-proyecto-${params.MICROSERVICE}-${env.ENVIRONMENT}:${env.VERSION}
                """
            }
        }
        stage('Pushear Imagen') {
            steps {
                sh """
                docker push uk.icr.io/cr-vsanchez/imagen-proyecto-${params.MICROSERVICE}-${env.ENVIRONMENT}:${env.VERSION}
                """
            }
        }
    }
}
